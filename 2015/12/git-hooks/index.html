<!DOCTYPE html>
<html lang="en_au">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=no"/>
    <meta name="robots" content=""/>

    <!-- Metadata -->
    <title>Git Hooks &ndash; Joshua Ellis's Blog</title>
<meta name="author" content="Joshua Ellis" />
<meta name="description" content="This blog is generated using Pelican which is based on Python, and in order to manage the differences between source code and the generated code, I use git hooks. I have it setup so that whenever I run git push, all the HTML files are regenerated and a new commit ..." />
<meta name="keywords" content="git">
<meta property="og:type" content="article"/>
<meta property="og:site_name" content="Joshua Ellis's Blog"/>
<meta property="og:title" content="Git Hooks"/>
<meta property="og:description" content="This blog is generated using Pelican which is based on Python, and in order to manage the differences between source code and the generated code, I use git hooks. I have it setup so that whenever I run git push, all the HTML files are regenerated and a new commit ..."/>
<meta property="og:url" content="https://jp-ellis.github.io/2015/12/git-hooks/"/>
<meta property="og:locale" content="en_AU"/>
<meta property="article:author" content="https://jp-ellis.github.io/author/joshua-ellis/">
<meta property="article:modified_time" content=""/>
<meta property="article:published_time" content="2015-12-08 00:00:00+11:00"/>
<meta property="article:section" content="blog"/>
<meta property="article:tag" content="git"/>

<!-- icons and bar theme -->
<meta name="theme-color" content="#D43400">
<link id="favicon" rel="shortcut icon" href="https://jp-ellis.github.io/theme/images/favicon-16.png" sizes="16x16">
<link id="favicon" rel="shortcut icon" href="https://jp-ellis.github.io/theme/images/favicon-32.png" sizes="32x32">
<link id="favicon" rel="shortcut icon" href="https://jp-ellis.github.io/theme/images/favicon-64.png" sizes="64x64">
<link id="favicon" rel="shortcut icon" href="https://jp-ellis.github.io/theme/images/favicon-128.png" sizes="128x128">
<link id="favicon" rel="shortcut icon" href="https://jp-ellis.github.io/theme/images/favicon-256.png" sizes="256x256"><!-- Share button -->
<link rel="stylesheet" type="text/css" href="https://jp-ellis.github.io/theme/css/share-button.min.css">
<script type="text/javascript" src="https://jp-ellis.github.io/theme/js/share-button.min.js"></script><!-- CSS Stylesheets -->
<link rel="stylesheet" type="text/css" href="https://jp-ellis.github.io/theme/css/style.min.css">
<!-- Feeds -->
<link href="https://jp-ellis.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Joshua Ellis's Blog Atom">
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>  </head>
  <body unresolved>
    <aside>
<a href="https://jp-ellis.github.io">
  <img src="https://jp-ellis.github.io/theme/images/profile.png" alt="Joshua Ellis" title="Joshua Ellis">
</a>
<h1><a href="https://jp-ellis.github.io">Joshua Ellis</a></h1>
<p>Masters of Physics Candidate</p>
<nav>
  <ul class="pages">
    <li><a href="https://jp-ellis.github.io/about/#about">About</a></li>
    <li><a href="https://jp-ellis.github.io/projects/#projects">Projects</a></li>
  </ul>
</nav>
<ul class="social">
  <li><a class="github" href="https://github.com/JP-Ellis" target="_blank"><i>Github</i></a></li>
  <li><a class="email" href="mailto:coujellis@gmail.com" target="_blank"><i>Email</i></a></li>
  <li><a class="linkedin" href="https://au.linkedin.com/in/joshuapellis" target="_blank"><i>LinkedIn</i></a></li>
</ul>
<ul class="feeds">
  <a href="https://jp-ellis.github.io/feeds/all.atom.xml">Atom</a>
  <a href="https://jp-ellis.github.io/sitemap.xml">Sitemap</a>
</ul>    </aside>
    <div class="content">
      <nav>
        <ul class="breadcrumb">
          <li class="home"><a href="https://jp-ellis.github.io">Home</a></li>
<li class="inter"><a href="https://jp-ellis.github.io/2015/">2015</a></li>
<li class="inter"><a href="https://jp-ellis.github.io/2015/12/">December</a></li>
<li class="active">Git Hooks</li>
        </ul>
      </nav>
      <main>
<article>
  <header>
    <div class="header-left">
      <h1 id="git-hooks">Git Hooks</h1>
      <span class="article-date">Posted on Tue 08 December 2015</span>
    </div>
    <share-button></share-button>
    <script>new ShareButton({ui: {flyout: "top left"}, networks: {pinterest: {enabled: false}}});</script>
  </header>
  <div class="content">
    <p>This blog is generated using <a class="reference external" href="http://getpelican.com/">Pelican</a> which is based on <a class="reference external" href="https://python.org/">Python</a>, and in order to
manage the differences between source code and the generated code, I use <a class="reference external" href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">git
hooks</a>.  I have it
setup so that whenever I run <tt class="docutils literal">git push</tt>, all the HTML files are regenerated
and a new commit is added and pushed in the <tt class="docutils literal">master</tt> branch (which ultimately
becomes the HTML is this site).</p>
<p>The following example goes through my setup with Github Pages, though it could
equivalently be used to push to another server, or anything else really since
the hook is a simple bash script.</p>
<div class="section" id="github-pages-setup">
<h2>Github Pages Setup</h2>
<p>I am using <a class="reference external" href="https://pages.github.com/">Github Pages</a> for this website which
serves the <tt class="docutils literal">master</tt> branch from the repository called <tt class="docutils literal"><span class="pre">jp-ellis.github.io</span></tt>.
I keep the source code in the <tt class="docutils literal">source</tt> branch which is independent to the
<tt class="docutils literal">master</tt> branch (and similarly for the <tt class="docutils literal">theme</tt> branch tracks <a class="footnote-reference" href="#theme" id="id2">[1]</a>).</p>
<p>The idea is to create separate repositories with separate branch names, and then
afterwards push them to the same remote repository:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="nb">cd</span> ~/web/jp-ellis.github.io
<span class="c"># Setup git and create a new source branch</span>
git init .
git checkout --orphan <span class="nb">source</span>
git remote add origin git@github.com:JP-Ellis/jp-ellis.github.io.git
<span class="c"># Setup the master branch</span>
git init ./output
git remote add origin git@github.com:JP-Ellis/jp-ellis.github.io.git
</pre></div>
</td></tr></table><p>At this stage, we have one repository inside the other.  We can make the parent
directory track the smaller directory with <a class="reference external" href="https://git-scm.com/book/en/v2/Git-Tools-Submodules">submodules</a>.  This is not strictly
necessary in this case as the code in the parent repository doesn't rely on the
sub-repository; however, this can be quite useful if the sub-repository is used
as a dependency.  The submodule can be create with:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nb">cd</span> ~/web/jp-ellis.github.io
git submodule add git@github.com:JP-Ellis/jp-ellis.github.io.git ./output
</pre></div>
</td></tr></table><p>At this stage, we can make all the changes to the code and commit them as usual,
and once ready we can commit the changes to the output and push everything.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="nb">cd</span> ~/web/jp-ellis.github.io
<span class="c"># Make all the appropriate commits</span>
<span class="c"># Push the source and set upstream</span>
git push --set-upstream origin <span class="nb">source</span>
<span class="nb">cd </span>output
<span class="c"># Similarly, make appropriate commits and push</span>
git push --set-upstream origin master
</pre></div>
</td></tr></table><p>At this stage, all the changes have been pushed to Github and the Github Pages
(assuming it has been enabled in the settings) should have updated and the
website is visible.  At this stage though, subsequent changes are annoying
because the commands in the last block of code have to be repeated every single
time---and knowing myself, I am bound to forget updating the output and pushing
the changes to the generated code.</p>
</div>
<div class="section" id="id3">
<h2>Git Hooks</h2>
<p>In order to automate the process of pushing the source, regenerating the output
and pushing the output, I want to use <a class="reference external" href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">Git hooks</a>.  Specifically, I
will have it setup such that every time I run <tt class="docutils literal">git push</tt> in the source, all
the steps I run automatically.</p>
<p>The hooks are simple executable scripts located in <tt class="docutils literal">.git/hooks/</tt>.  By default,
new repositories have a few sample scripts which end in <tt class="docutils literal">.sample</tt> which can be
put to use by removing the extension.</p>
<p>In my particular case, I want to regenerate the output through <a class="reference external" href="http://getpelican.com/">Pelican</a>,
automatically commit all the changes in the <tt class="docutils literal">./output</tt> directory and finally
push both generated code and the source code.  The <tt class="docutils literal"><span class="pre">pre-push</span></tt> hook is what I
need for that as it is run before <tt class="docutils literal">git push</tt>.  The annotated content of my
<tt class="docutils literal"><span class="pre">pre-push</span></tt> script is:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/sh</span>

<span class="c"># Get the short hash of the latest source commit</span>
<span class="nv">commit_hash</span><span class="o">=</span><span class="k">$(</span>git rev-parse --short HEAD<span class="k">)</span>
<span class="c"># Regenerate the output, and return an error if it fails (otherwise move on)</span>
make publish <span class="o">||</span> <span class="k">return</span> 1
<span class="c"># Move to the output directory</span>
<span class="nb">cd </span>output
<span class="c"># Tell git we&#39;re working on a different repository</span>
<span class="nb">export </span><span class="nv">GIT_WORK_TREE</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>
<span class="c"># If there are no changes (i.e. git diff exist with 1),</span>
git diff --exit-code 2&gt;<span class="p">&amp;</span><span class="m">1</span> &gt;/dev/null
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -eq <span class="m">1</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c"># Stage, commit and push everything</span>
    git add --all
    git commit -m <span class="s2">&quot;Update to </span><span class="si">${</span><span class="nv">commit_hash</span><span class="si">}</span><span class="s2">.&quot;</span>
    git push
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;No changes to &#39;output&#39;.&quot;</span>
<span class="k">fi</span>
</pre></div>
</td></tr></table><p>Finally, with all this setup I just need to run <tt class="docutils literal">git push</tt> and the website will be automatically updated!</p>
<table class="docutils footnote" frame="void" id="theme" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>The reason for the theme being tracked in a separate branch is that
I may end up moving the branch to its own proper repository in the
future, and I could do the same for the source branch though I think
it makes more sense to keep the source and output in the same
repositories.</td></tr>
</tbody>
</table>
</div>

  </div>
  <div class="tags">
    <a class="label label-primary" href="https://jp-ellis.github.io/tag/git/">git</a>
  </div>
<div id="disqus_thread"></div>
<script>
 var disqus_config = function () {
   this.page.url = "https://jp-ellis.github.io/2015/12/git-hooks/";
   this.page.identifier = "2015-12-08-git-hooks";
 };
 (function() {
   var d = document, s = d.createElement('script');
   s.src = '//jpellisgithubio.disqus.com/embed.js';
   s.setAttribute('data-timestamp', +new Date());
   (d.head || d.body).appendChild(s);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>
      </main>
      <footer>
<p>
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
    <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by-sa/4.0/80x15.png"/>
  </a>
  &copy; Joshua Ellis  &ndash;
  This work is licensed under an <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
    Attribution-ShareAlike 4.0 International License
  </a>
</p><p>
  Built using <a href="http://getpelican.com" target="_blank">Pelican</a>
  &ndash;
  Theme by <a href="http://jp-ellis.github.io" target="_blank">Joshua Ellis</a>
</p>      </footer>
    </div>

<script type="text/javascript">
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

 ga('create', 'UA-62514224-3', 'auto');
 ga('send', 'pageview');
</script>

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Git Hooks",
  "headline": "Git Hooks",
  "datePublished": "2015-12-08 00:00:00+11:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Joshua Ellis",
    "url": "https://jp-ellis.github.io/author/joshua-ellis/"
  },
  "image": "",
  "url": "https://jp-ellis.github.io/2015/12/git-hooks/",
  "description": "This blog is generated using Pelican which is based on Python, and in order to manage the differences between source code and the generated code, I use git hooks. I have it setup so that whenever I run git push, all the HTML files are regenerated and a new commit ..."
}
</script>
  </body>
</html>